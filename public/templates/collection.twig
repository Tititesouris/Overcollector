{% import "cosmetic.twig" as cosmeticMacro %}
{% extends "page.twig" %}
{% block body %}
    {% set heroStats = {} %}
    {% for hero, types in SESSION.allcosmetics %}
        {% set heroOwned = 0 %}
        {% set heroTotal = 0 %}
        {% set typesStats = {} %}
        {% for type, cosmetics in types %}
            {% set typeTotal = cosmetics|length %}
            {% set typeOwned = 0 %}
            {% for cosmetic in cosmetics %}
                {% if SESSION.user.hasCosmetic(cosmetic.id) %}
                    {% set typeOwned = typeOwned + 1 %}
                {% endif %}
            {% endfor %}
            {% set typesStats = typesStats|merge({("type-" ~ type): {"owned": typeOwned, "total": typeTotal}}) %}
            {% set heroOwned = heroOwned + typeOwned %}
            {% set heroTotal = heroTotal + typeTotal %}
        {% endfor %}
        {% set heroStats = heroStats|merge({("hero-" ~ hero): {"owned": heroOwned, "total": heroTotal, "types": typesStats}}) %}
    {% endfor %}
    <!--suppress HtmlUnknownTarget, HtmlUnknownAnchorTarget -->
    <div class="mdl-grid">
        <div id="cosmetics-menu" class="mdl-cell mdl-cell--3-col">
            <ul class="demo-list-icon mdl-list mdl-shadow--2dp">
                <li class="cosmetics-menu--update mdl-list__item">
                    <span class="mdl-list__item-primary-content">
                        <button class="cosmetics-menu--update-refresh mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                            Refresh
                        </button>
                        <button id="show-dialog"
                                class="cosmetics-menu--update-import mdl-button mdl-js-button mdl-button--raised">
                            Import
                        </button>
                        <dialog id="import-collection--dialog" class="mdl-dialog">
                            <h4 class="mdl-dialog__title">Import</h4>
                            <div class="mdl-dialog__content">
                                <p>
                                    Import your collection by pasting your collection data here. It will replace the current collection, <b>there is no way back</b>.<br />
                                    <b>We strongly suggest that you export the current collection before importing a new one.</b>
                                </p>
                                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                    <textarea id="import-collection--textarea" class="mdl-textfield__input" type="text" rows="3" maxrows="3"></textarea>
                                    <label class="mdl-textfield__label" for="import-collection--textarea">Collection data (JSON format)</label>
                                    <span class="mdl-textfield__error">Data isn't formatted correctly</span>
                                </div>
                            </div>
                            <div class="mdl-dialog__actions">
                                <button type="button" class="mdl-button mdl-button--raised mdl-button--colored confirm">Import</button>
                                <button type="button" class="mdl-button mdl-button--raised close">Cancel</button>
                            </div>
                        </dialog>
                        <button class="cosmetics-menu--update-export mdl-button mdl-js-button mdl-button--raised">
                            Export
                        </button>
                    </span>
                </li>
                <hr/>
                <li class="mdl-list__item">
                    <span class="mdl-list__item-primary-content mdl-typography--font-bold">
                        Show Owned
                    </span>
                    <span class="mdl-list__item-secondary-action">
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-show-owned">
                            <input type="checkbox" id="switch-show-owned" class="setting-input mdl-switch__input"
                                   data-setting="collection-show-owned-cosmetics" {{ SESSION.user.settings["collection-show-owned-cosmetics"].value ?? true ? "checked" }}>
                        </label>
                    </span>
                </li>
                <hr/>
                <li class="cosmetics-menu--toggle mdl-list__item">
                    <span class="mdl-list__item-primary-content mdl-typography--font-bold">
                        Heroes
                    </span>
                    <span class="mdl-list__item-secondary-action">
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-all-heroes">
                            <input type="checkbox" id="switch-all-heroes" class="setting-input mdl-switch__input"
                                   data-setting="collection-show-heroes" {{ SESSION.user.settings["collection-show-heroes"].value ?? true ? "checked" }}>
                        </label>
                    </span>
                </li>
                {% set ratio = heroStats["hero-0"].owned / heroStats["hero-0"].total %}
                <li class="cosmetics-menu--item mdl-list__item"
                    style="background-color: {{ ratio|colorgradient("rgba") }};">
                    <span class="mdl-list__item-primary-content">
                        <a href="#allheroes">
                            <span class="cosmetics-menu--item--image">
                                <img src="img/collection/heroes/allheroes.png"/>All Heroes
                            </span>
                            <span class="cosmetics-menu--item--stats">
                                {{ (ratio * 100)|round(2, 'floor') }}% ({{ heroStats["hero-0"].owned }}
                                / {{ heroStats["hero-0"].total }})
                            </span>
                        </a>
                    </span>
                    <span class="mdl-list__item-secondary-action">
                        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="hero-checkbox-allheroes">
                            <input type="checkbox" id="hero-checkbox-allheroes"
                                   class="setting-input mdl-checkbox__input"
                                   data-setting="collection-show-hero-allheroes" {{ SESSION.user.settings["collection-show-hero-allheroes"].value ?? true ? "checked" }}/>
                        </label>
                    </span>
                </li>
                {% for hero in SESSION.heroes %}
                    {% set heroStat = heroStats["hero-"~hero.id] is defined ? heroStats["hero-"~hero.id] : null %}
                    {% set ratio = heroStat != null ? (heroStat.owned / heroStat.total) : 1 %}
                    <li class="cosmetics-menu--item mdl-list__item"
                        style="background-color: {{ ratio|colorgradient("rgba") }};">
                        <span class="mdl-list__item-primary-content">
                            <a href="#{{ hero.slug }}">
                                <span class="cosmetics-menu--item--image">
                                    <img src="img/collection/heroes/{{ hero.slug }}.png"/>{{ hero.name }}
                                </span>
                                <span class="cosmetics-menu--item--stats">
                                    {{ (ratio * 100)|round(2, "floor") }}% ({{ heroStat.owned ?? 0 }}
                                    / {{ heroStat.total ?? 0 }})
                                </span>
                            </a>
                        </span>
                        <span class="mdl-list__item-secondary-action">
                            <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect"
                                   for="hero-checkbox-{{ hero.slug }}">
                                <input type="checkbox" id="hero-checkbox-{{ hero.slug }}"
                                       class="setting-input mdl-checkbox__input"
                                       data-setting="collection-show-hero-{{ hero.slug }}"
                                        {{ SESSION.user.settings["collection-show-hero-" ~ hero.slug].value ?? true ? "checked" }}/>
                            </label>
                        </span>
                    </li>
                {% endfor %}
                <hr/>
                <li class="cosmetics-menu--toggle mdl-list__item">
                    <span class="mdl-list__item-primary-content mdl-typography--font-bold">
                        Categories
                    </span>
                    <span class="mdl-list__item-secondary-action">
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-all-categories">
                            <input type="checkbox" id="switch-all-categories" class="setting-input mdl-switch__input"
                                   data-setting="collection-show-categories" {{ SESSION.user.settings["collection-show-categories"].value ?? true ? "checked" }}>
                        </label>
                    </span>
                </li>
                <li class="cosmetics-menu--item cosmetics-menu--item-category mdl-list__item">
                    <span class="cosmetics-menu--item--image mdl-list__item-primary-content">
                        <img src="img/collection/categories/default.png"/>Default
                    </span>
                    <span id="cosmetics-menu--category-default" class="mdl-list__item-secondary-action">
                        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect"
                               for="category-checkbox-default">
                            <input type="checkbox" id="category-checkbox-default"
                                   class="setting-input mdl-checkbox__input"
                                   data-setting="collection-show-category-default" {{ SESSION.user.settings["collection-show-category-default"].value ?? true ? "checked" }}/>
                        </label>
                    </span>
                    <div class="mdl-tooltip" data-mdl-for="cosmetics-menu--category-default">
                        Obtained by default
                    </div>
                </li>
                {% for category in SESSION.categories %}
                    <li class="cosmetics-menu--item cosmetics-menu--item-category mdl-list__item">
                        <span class="cosmetics-menu--item--image mdl-list__item-primary-content">
                            <img src="img/collection/categories/{{ category.slug }}.png"/>{{ category.name }}
                        </span>
                        <span id="cosmetics-menu--category-{{ category.slug }}"
                              class="mdl-list__item-secondary-action">
                            <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect"
                                   for="category-checkbox-{{ category.slug }}">
                                <input type="checkbox" id="category-checkbox-{{ category.slug }}"
                                       class="setting-input mdl-checkbox__input"
                                       data-setting="collection-show-category-{{ category.slug }}"
                                        {{ SESSION.user.settings["collection-show-category-" ~ category.slug].value ?? true ? "checked" }}/>
                            </label>
                        </span>
                        <div class="mdl-tooltip"
                             data-mdl-for="cosmetics-menu--category-{{ category.slug }}">
                            {{ category.description|breverynword(5) }}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="mdl-cell mdl-cell--9-col-desktop">
            <table id="cosmetics-table" class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
                {% for hero, types in SESSION.cosmetics %}
                    {% set ratio = heroStats["hero-"~hero].owned / heroStats["hero-"~hero].total %}
                    <tbody class="cosmetics-table--body">
                    <tr class="cosmetics-table--hero"
                        style="background-color: {{ ratio|colorgradient("rgba") }};">
                        <td colspan="{{ SESSION.user.settings["collection-cosmetics-per-row"].value ?? 3 - 1 }}"
                            class="mdl-typography--headline mdl-data-table__cell--non-numeric">
                            <a name="{{ hero > 0 ? SESSION.heroes[hero].slug : "allheroes" }}">
                                {{ hero > 0 ? SESSION.heroes[hero].name : "All Heroes" }}
                            </a>
                        </td>
                        <td>
                            {{ (ratio * 100)|round(2, 'floor') }}%
                            ({{ heroStats["hero-"~hero].owned }} / {{ heroStats["hero-"~hero].total }})
                        </td>
                    </tr>
                    {% for type, cosmetics in types %}
                        {% set ratio = heroStats["hero-"~hero].types["type-"~type].owned / heroStats["hero-"~hero].types["type-"~type].total %}
                        <tr class="cosmetics-table--type"
                            style="background-color: {{ ratio|colorgradient("rgba") }};">
                            <td colspan="{{ SESSION.user.settings["collection-cosmetics-per-row"].value ?? 3 - 1 }}">
                                {{ SESSION.types[type].name }}s
                            </td>
                            <td>
                                {{ (ratio * 100)|round(2, 'floor') }}%
                                ({{ heroStats["hero-"~hero].types["type-"~type].owned }}
                                / {{ heroStats["hero-"~hero].types["type-"~type].total }})
                            </td>
                        </tr>
                        {% for row in cosmetics|batch(SESSION.user.settings["collection-cosmetics-per-row"].value ?? 3) %}
                            <tr>
                                {% for cosmetic in row %}
                                    <td class="cosmetics-table--category category-{{ cosmetic.category is not null ? cosmetic.category.id : 0 }}">
                                        {{ cosmeticMacro.cosmetic(cosmetic, SESSION.user.hasCosmetic(cosmetic.id)) }}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    {% endfor %}
                    </tbody>
                {% endfor %}
            </table>
        </div>
    </div>

{% endblock %}